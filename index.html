<!DOCTYPE html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Jalal Vision | Building a Legacy</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Arial", sans-serif;
        overflow: hidden;
        user-select: none;
      }

      .container {
        position: relative;
        width: 100vw;
        height: 100vh;
        background: radial-gradient(
          circle at top center,
          #4f472c 0%,
          #000000 70%
        );
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
      }

      .logo-imge {
        width: 500px;
        height: 150px;
        object-fit: contain;
        margin-bottom: 20px;
        position: relative;
        z-index: 9999999;
      }

      .logo-imge.viewer-active {
        bottom: 0px !important;
        left: 0px !important;
        position: fixed !important;
        width: 200px !important;
        height: 143px !important;
      }

      .upload-area {
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        border: 2px dashed #fff;
        border-radius: 20px;
        padding: 40px;
        text-align: center;
        color: white;
        z-index: 100;
        transition: all 0.3s ease;
        max-width: 90%;
      }

      .upload-area:hover {
        background: rgba(255, 255, 255, 0.15);
      }

      .upload-button {
        background: radial-gradient(
          circle at top center,
          #4f472c 0%,
          #000000 70%
        );
        border: none;
        padding: 15px 30px;
        border-radius: 25px;
        color: white;
        font-size: 16px;
        cursor: pointer;
        margin: 10px;
        transition: all 0.3s ease;
      }

      .upload-button:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 25px #4f472c;
      }

      .viewer {
        position: absolute;
        width: 100%;
        height: 100%;
        display: none;
        cursor: grab;
      }

      .viewer:active {
        cursor: grabbing;
      }

      .controls {
        position: absolute;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0, 0, 0, 0.8);
        border-radius: 25px;
        padding: 15px;
        display: none;
        gap: 10px;
        z-index: 50;
        align-items: center;
      }

      .control-btn {
        background: rgba(255, 255, 255, 0.2);
        border: none;
        border-radius: 5px;
        padding: 10px 15px;
        color: white;
        cursor: pointer;
        font-size: 14px;
      }

      .control-btn:hover {
        background: rgba(255, 255, 255, 0.3);
      }

      .nav-btn {
        background: rgba(102, 126, 234, 0.3);
        border: none;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        color: white;
        cursor: pointer;
        font-size: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .nav-btn:hover {
        background: rgba(102, 126, 234, 0.5);
        transform: scale(1.1);
      }

      .nav-btn:disabled {
        opacity: 0.3;
        cursor: not-allowed;
      }

      .image-counter {
        color: white;
        font-size: 14px;
        background: rgba(0, 0, 0, 0.5);
        padding: 10px 15px;
        border-radius: 15px;
        margin: 0 10px;
        text-align: center;
        min-width: 120px;
      }

      .loading {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        color: white;
        font-size: 18px;
        display: none;
        z-index: 75;
        text-align: center;
      }

      .spinner {
        border: 3px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        border-top: 3px solid white;
        width: 50px;
        height: 50px;
        animation: spin 1s linear infinite;
        margin: 0 auto 20px;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .hidden {
        display: none !important;
      }

      .test-panel {
        position: absolute;
        top: 20px;
        left: 20px;
        background: rgba(0, 0, 0, 0.9);
        color: white;
        padding: 20px;
        border-radius: 10px;
        display: none;
        z-index: 80;
        max-width: 300px;
        max-height: 90vh;
        overflow-y: auto;
      }

      .test-panel button {
        background: #333;
        color: white;
        border: none;
        padding: 8px 12px;
        margin: 3px;
        border-radius: 3px;
        cursor: pointer;
        font-size: 12px;
      }

      .test-panel button:hover {
        background: #555;
      }

      .test-panel select {
        background: #333;
        color: white;
        border: 1px solid #555;
        padding: 5px;
        border-radius: 3px;
        width: 100%;
        margin: 5px 0;
      }

      /* Tablet Styles */
      @media (max-width: 1024px) {
        .logo-imge {
          width: 350px;
          height: 105px;
        }

        .upload-area {
          padding: 30px;
          max-width: 85%;
        }

        .upload-area h2 {
          font-size: 22px;
        }

        .upload-button {
          padding: 12px 25px;
          font-size: 15px;
        }

        .controls {
          padding: 12px;
          gap: 8px;
        }

        .control-btn {
          padding: 8px 12px;
          font-size: 13px;
        }

        .nav-btn {
          width: 45px;
          height: 45px;
          font-size: 18px;
        }

        .test-panel {
          max-width: 250px;
          padding: 15px;
          font-size: 13px;
        }
      }

      /* Mobile Styles */
      @media (max-width: 768px) {
        .logo-imge {
          width: 200px;
          height: 60px;
          margin-bottom: 15px;
        }

        .upload-area {
          padding: 25px 20px;
          max-width: 90%;
          border-radius: 15px;
        }

        .upload-area h2 {
          font-size: 20px;
          margin-bottom: 10px;
        }

        .upload-area p {
          font-size: 14px;
          margin: 15px 0 !important;
        }

        .upload-area > div {
          font-size: 11px !important;
          padding: 8px !important;
          margin: 10px 0 !important;
        }

        .upload-button {
          padding: 12px 20px;
          font-size: 14px;
          margin: 8px;
          width: calc(100% - 16px);
          max-width: 280px;
        }

        .controls {
          bottom: 10px;
          left: 10px;
          right: 10px;
          width: calc(100% - 20px);
          transform: none;
          padding: 12px 10px;
          border-radius: 15px;
          gap: 8px;
          flex-wrap: wrap;
          justify-content: space-between;
        }

        .control-btn {
          flex: 1 1 calc(33.333% - 6px);
          min-width: 0;
          padding: 10px 8px;
          font-size: 13px;
          border-radius: 8px;
        }

        .nav-btn {
          width: 45px;
          height: 45px;
          font-size: 18px;
          flex-shrink: 0;
        }

        .image-counter {
          flex: 1 1 100%;
          order: -1;
          margin: 0 0 8px 0;
          font-size: 13px;
          padding: 8px 10px;
        }

        .image-counter > div:first-child {
          font-size: 13px;
        }

        .image-counter > div:last-child {
          font-size: 10px;
          max-width: 100% !important;
        }

        .logo-imge.viewer-active {
          position: fixed !important;
          top: 10px !important;
          left: 10px !important;
          width: 80px !important;
          height: 80px !important;
          z-index: 60;
        }

        .test-panel {
          top: 10px;
          left: 10px;
          right: 10px;
          max-width: calc(100% - 20px);
          padding: 15px;
          font-size: 12px;
          max-height: 80vh;
        }

        .test-panel h4 {
          font-size: 14px;
        }

        .test-panel button {
          padding: 10px 12px;
          font-size: 13px;
          touch-action: manipulation;
        }

        .test-panel select {
          padding: 8px;
          font-size: 13px;
        }

        .loading {
          font-size: 16px;
          padding: 0 20px;
        }

        .spinner {
          width: 40px;
          height: 40px;
        }
      }

      /* Small Mobile Styles */
      @media (max-width: 480px) {
        .logo-imge {
          width: 170px;
          height: 140px;
          object-fit: cover !important;
        }

        .upload-area {
          padding: 20px 15px;
        }

        .upload-area h2 {
          font-size: 18px;
        }

        .upload-area p {
          font-size: 13px;
        }

        .upload-button {
          padding: 10px 18px;
          font-size: 13px;
        }

        .controls {
          bottom: 8px;
          left: 8px;
          right: 8px;
          width: calc(100% - 16px);
          padding: 10px 8px;
          gap: 6px;
        }

        .control-btn {
          padding: 9px 6px;
          font-size: 12px;
        }

        .nav-btn {
          width: 42px;
          height: 42px;
          font-size: 16px;
        }

        .image-counter {
          font-size: 12px;
          padding: 6px 8px;
        }

        .logo-imge.viewer-active {
          width: 83px !important;
          height: 100px !important;
          object-fit: cover !important;
        }
      }

      /* Landscape Mobile */
      @media (max-height: 500px) and (orientation: landscape) {
        .logo-imge {
          width: 150px;
          height: 45px;
          margin-bottom: 10px;
        }

        .upload-area {
          padding: 15px;
          max-height: 80vh;
          overflow-y: auto;
        }

        .upload-area h2 {
          font-size: 16px;
        }

        .upload-button {
          padding: 8px 15px;
          font-size: 12px;
          margin: 5px;
        }

        .controls {
          bottom: 5px;
          padding: 8px;
        }

        .control-btn {
          padding: 6px 10px;
          font-size: 11px;
        }

        .nav-btn {
          width: 38px;
          height: 38px;
          font-size: 14px;
        }

        .logo-imge.viewer-active {
          width: 60px !important;
          height: 60px !important;
          top: 5px !important;
          left: 5px !important;
        }

        .test-panel {
          max-height: 70vh;
          font-size: 11px;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <img class="logo-imge" src="./remove-up (1).png" />
      <!-- Upload Area -->
      <div class="upload-area" id="uploadArea">
        <h2>Galal Preview</h2>
        <p style="margin: 20px 0">ÿ¨ÿßÿ±Ÿä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿµŸàÿ± ŸÖŸÜ ÿßŸÑÿ≥Ÿäÿ±ŸÅÿ±...</p>
        <div
          style="
            font-size: 12px;
            opacity: 0.8;
            margin: 15px 0;
            padding: 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
          "
        >
          <strong>üìã ŸÖŸÑÿßÿ≠ÿ∏ÿ©:</strong><br />
          Ÿäÿ™ŸÖ ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ
        </div>
        <div
          id="loadingStatus"
          style="margin: 20px 0; font-size: 14px; opacity: 0.8"
        ></div>
      </div>

      <!-- Loading -->
      <div class="loading" id="loading">
        <div class="spinner"></div>
        ÿ¨ÿßÿ±Ÿä ÿßŸÑŸÖÿπÿßŸÑÿ¨ÿ©...
      </div>

      <!-- Test Panel -->
      <div class="test-panel" id="testPanel">
        <h4>üß™ Face Tester</h4>
        <select id="faceSelect" onchange="updateTransformDisplay()">
          <option value="0">Front</option>
          <option value="1">Back</option>
          <option value="2">Top</option>
          <option value="3">Bottom</option>
          <option value="4">Right</option>
          <option value="5">Left</option>
        </select>

        <div
          id="currentSteps"
          style="
            margin: 10px 0;
            padding: 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
            min-height: 30px;
            font-size: 11px;
          "
        >
          <strong>Current:</strong> <span id="stepsDisplay">180¬∞</span>
        </div>

        <div style="margin-top: 10px; font-size: 11px; opacity: 0.7">
          Add Transform:
        </div>
        <div>
          <button onclick="addTransform(1)">+ Flip H</button>
          <button onclick="addTransform(2)">+ Flip V</button>
          <button onclick="addTransform(3)">+ Flip Both</button>
        </div>
        <div style="margin-top: 5px">
          <button onclick="addTransform(4)">+ Rotate 90¬∞</button>
          <button onclick="addTransform(5)">+ Rotate 180¬∞</button>
          <button onclick="addTransform(6)">+ Rotate 270¬∞</button>
        </div>

        <div style="margin-top: 10px; display: flex; gap: 5px">
          <button
            onclick="undoLastTransform()"
            style="background: #666; flex: 1"
          >
            ‚Ü∂ Undo
          </button>
          <button onclick="clearTransforms()" style="background: #444; flex: 1">
            Clear
          </button>
        </div>

        <div style="margin-top: 10px">
          <button onclick="resetAll()" style="background: #5c0a0a; width: 100%">
            Reset All Faces
          </button>
        </div>
      </div>

      <!-- Viewer -->
      <canvas class="viewer" id="viewer"></canvas>

      <!-- Controls -->
      <div class="controls" id="controls">
        <button class="nav-btn" id="nextBtn" onclick="nextImage()">‚ñ∂</button>
        <div class="image-counter" id="imageCounter">1 / 1</div>
        <button class="control-btn" onclick="resetView()">üè† Reset</button>
        <button class="control-btn" onclick="toggleAutoRotate()">
          üîÑ Auto
        </button>
        <button class="control-btn" onclick="toggleTest()">üß™ Test</button>
        <button class="nav-btn" id="prevBtn" onclick="previousImage()">
          ‚óÄ
        </button>
      </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script>
      // Global variables
      let scene, camera, renderer, mesh;
      let originalImages = [];
      let currentImageIndex = 0;
      let autoRotate = false;
      let testMode = false;

      // Face transforms
      let faceTransforms = [
        [2], // front: 180¬∞
        [1, 5], // back: Flip H + 180¬∞
        [1, 6], // top: Flip H + 270¬∞
        [1, 4], // bottom: Flip H + 90¬∞
        [1, 5], // right: Flip H + 180¬∞
        [1, 5], // left: Flip H + 180¬∞
      ];

      // Mouse control
      let isMouseDown = false;
      let mouseX = 0,
        mouseY = 0;
      let phi = 0,
        theta = Math.PI / 2;
      let targetPhi = 0,
        targetTheta = Math.PI / 2;
      let animStarted = false;

      function init() {
        const canvas = document.getElementById("viewer");
        scene = new THREE.Scene();
        camera = new THREE.PerspectiveCamera(
          75,
          window.innerWidth / window.innerHeight,
          0.1,
          1000
        );
        camera.position.set(0, 0, 0);
        renderer = new THREE.WebGLRenderer({ canvas: canvas, antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
      }

      function applySingleTransform(canvas, transformType) {
        const newCanvas = document.createElement("canvas");
        const ctx = newCanvas.getContext("2d");
        newCanvas.width = canvas.width;
        newCanvas.height = canvas.height;

        ctx.save();

        switch (transformType) {
          case 0:
            ctx.drawImage(canvas, 0, 0);
            break;
          case 1:
            ctx.scale(-1, 1);
            ctx.drawImage(canvas, -canvas.width, 0);
            break;
          case 2:
            ctx.scale(1, -1);
            ctx.drawImage(canvas, 0, -canvas.height);
            break;
          case 3:
            ctx.scale(-1, -1);
            ctx.drawImage(canvas, -canvas.width, -canvas.height);
            break;
          case 4:
            ctx.translate(canvas.width / 2, canvas.height / 2);
            ctx.rotate(Math.PI / 2);
            ctx.drawImage(canvas, -canvas.width / 2, -canvas.height / 2);
            break;
          case 5:
            ctx.translate(canvas.width / 2, canvas.height / 2);
            ctx.rotate(Math.PI);
            ctx.drawImage(canvas, -canvas.width / 2, -canvas.height / 2);
            break;
          case 6:
            ctx.translate(canvas.width / 2, canvas.height / 2);
            ctx.rotate((3 * Math.PI) / 2);
            ctx.drawImage(canvas, -canvas.width / 2, -canvas.height / 2);
            break;
        }

        ctx.restore();
        return newCanvas;
      }

      function applyTransformSteps(canvas, transformSteps) {
        let currentCanvas = canvas;
        for (let step of transformSteps) {
          currentCanvas = applySingleTransform(currentCanvas, step);
        }
        return currentCanvas;
      }

      function createCubeMap(image) {
        const canvas = document.createElement("canvas");
        const ctx = canvas.getContext("2d");
        const faceSize = image.height;
        canvas.width = faceSize;
        canvas.height = faceSize;
        const faces = [];

        for (let i = 0; i < 6; i++) {
          ctx.clearRect(0, 0, faceSize, faceSize);
          ctx.drawImage(
            image,
            i * faceSize,
            0,
            faceSize,
            faceSize,
            0,
            0,
            faceSize,
            faceSize
          );

          const transformedCanvas = applyTransformSteps(
            canvas,
            faceTransforms[i]
          );

          const texture = new THREE.CanvasTexture(transformedCanvas);
          texture.flipY = false;
          texture.wrapS = THREE.ClampToEdgeWrapping;
          texture.wrapT = THREE.ClampToEdgeWrapping;

          faces.push(texture);
        }

        return faces;
      }

      async function loadImagesFromServer() {
        const statusDiv = document.getElementById("loadingStatus");
        const baseUrl =
          "https://pub-cd33190839e0462ab72c4629e422fd3d.r2.dev/B/v2/";
        const imagePrefix = "v2.";
        const startFrom = 1;
        const totalImages = 78;

        statusDiv.textContent = "ÿ¨ÿßÿ±Ÿä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿµŸàÿ±...";
        document.getElementById("loading").style.display = "block";

        originalImages = [];
        let successCount = 0;

        function tryLoadImage(imageNumber) {
          return new Promise((resolve) => {
            const img = new Image();
            img.crossOrigin = "anonymous";

            img.onload = () => {
              img.fileName = `${imagePrefix}${imageNumber}.jpg`;
              img.index = parseInt(imageNumber, 10);
              resolve(img);
            };

            img.onerror = () => resolve(null);

            img.src = `${baseUrl}${imagePrefix}${imageNumber}.jpg`;
          });
        }

        const loadPromises = [];

        for (let i = startFrom; i <= totalImages; i++) {
          const imageNumber = String(i).padStart(4, "0");

          loadPromises.push(
            tryLoadImage(imageNumber).then((img) => {
              if (img) {
                successCount++;
                statusDiv.textContent = `ÿ™ŸÖ ÿ™ÿ≠ŸÖŸäŸÑ ${successCount} ÿµŸàÿ±ÿ©`;
              }
              return img;
            })
          );
        }

        const results = await Promise.all(loadPromises);

        originalImages = results
          .filter(Boolean)
          .sort((a, b) => a.index - b.index);

        if (originalImages.length > 0) {
          createViewer(originalImages[0]);
          updateImageCounter();
          updateNavigationButtons();
          statusDiv.textContent = "ÿ™ŸÖ ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ ÿ®ŸÜÿ¨ÿßÿ≠ üéâ";
          statusDiv.style.color = "#4CAF50";
        } else {
          statusDiv.textContent = "ŸÑŸÖ Ÿäÿ™ŸÖ ÿßŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸâ ÿµŸàÿ±";
          document.getElementById("loading").style.display = "none";
        }
      }

      function createViewer(image) {
        try {
          if (image.width / image.height !== 6) {
            alert("ÿßŸÑÿµŸàÿ±ÿ© Ÿäÿ¨ÿ® ÿ£ŸÜ ÿ™ŸÉŸàŸÜ ÿ®ŸÜÿ≥ÿ®ÿ© 6:1 (Corona Cube Map)");
            document.getElementById("loading").style.display = "none";
            return;
          }

          const faces = createCubeMap(image);

          if (mesh) {
            scene.remove(mesh);
          }

          const geometry = new THREE.BoxGeometry(500, 500, 500);
          const materials = [
            new THREE.MeshBasicMaterial({
              map: faces[4],
              side: THREE.BackSide,
            }), // Right
            new THREE.MeshBasicMaterial({
              map: faces[5],
              side: THREE.BackSide,
            }), // Left
            new THREE.MeshBasicMaterial({
              map: faces[2],
              side: THREE.BackSide,
            }), // Top
            new THREE.MeshBasicMaterial({
              map: faces[3],
              side: THREE.BackSide,
            }), // Bottom
            new THREE.MeshBasicMaterial({
              map: faces[1],
              side: THREE.BackSide,
            }), // Back
            new THREE.MeshBasicMaterial({
              map: faces[0],
              side: THREE.BackSide,
            }), // Front
          ];

          mesh = new THREE.Mesh(geometry, materials);
          scene.add(mesh);

          showViewer();
        } catch (error) {
          console.error("Error:", error);
          alert("ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ŸÅŸä ŸÖÿπÿßŸÑÿ¨ÿ© ÿßŸÑÿµŸàÿ±ÿ©");
          document.getElementById("loading").style.display = "none";
        }
      }

      function showViewer() {
        document.getElementById("loading").style.display = "none";
        document.getElementById("uploadArea").style.display = "none";
        document.getElementById("viewer").style.display = "block";
        document.querySelector(".logo-imge").classList.add("viewer-active");
        document.getElementById("controls").style.display = "flex";

        if (!animStarted) {
          animStarted = true;
          animate();
        }
      }

      function updateCamera() {
        phi += (targetPhi - phi) * 0.2;
        theta += (targetTheta - theta) * 0.05;
        const x = Math.sin(phi) * Math.sin(theta);
        const y = Math.cos(theta);
        const z = Math.cos(phi) * Math.sin(theta);
        camera.lookAt(x, y, z);
      }

      function animate() {
        requestAnimationFrame(animate);
        if (autoRotate) {
          targetPhi += 0.005;
        }
        updateCamera();
        renderer.render(scene, camera);
      }

      function resetView() {
        targetPhi = 0;
        targetTheta = Math.PI / 2;
        phi = 0;
        theta = Math.PI / 2;
        camera.fov = 75;
        camera.updateProjectionMatrix();
      }

      function toggleAutoRotate() {
        autoRotate = !autoRotate;
      }

      function toggleTest() {
        testMode = !testMode;
        const panel = document.getElementById("testPanel");
        panel.style.display = testMode ? "block" : "none";
        if (testMode) {
          updateTransformDisplay();
        }
      }

      function getTransformName(transformType) {
        const names = {
          0: "None",
          1: "Flip H",
          2: "Flip V",
          3: "Flip Both",
          4: "90¬∞",
          5: "180¬∞",
          6: "270¬∞",
        };
        return names[transformType] || "Unknown";
      }

      function updateTransformDisplay() {
        const faceIndex = parseInt(document.getElementById("faceSelect").value);
        const steps = faceTransforms[faceIndex];
        const display = document.getElementById("stepsDisplay");

        if (steps.length === 0) {
          display.textContent = "None";
        } else {
          display.textContent = steps
            .map((s) => getTransformName(s))
            .join(" ‚Üí ");
        }
      }

      function addTransform(transformType) {
        if (originalImages.length === 0) return;

        const faceIndex = parseInt(document.getElementById("faceSelect").value);
        faceTransforms[faceIndex].push(transformType);

        updateTransformDisplay();
        createViewer(originalImages[currentImageIndex]);
      }

      function undoLastTransform() {
        if (originalImages.length === 0) return;

        const faceIndex = parseInt(document.getElementById("faceSelect").value);
        if (faceTransforms[faceIndex].length > 0) {
          faceTransforms[faceIndex].pop();
          updateTransformDisplay();
          createViewer(originalImages[currentImageIndex]);
        }
      }

      function clearTransforms() {
        if (originalImages.length === 0) return;

        const faceIndex = parseInt(document.getElementById("faceSelect").value);
        faceTransforms[faceIndex] = [];

        updateTransformDisplay();
        createViewer(originalImages[currentImageIndex]);
      }

      function resetAll() {
        faceTransforms = [[5], [1, 5], [1, 6], [1, 4], [1, 5], [1, 5]];
        updateTransformDisplay();
        if (originalImages.length > 0) {
          createViewer(originalImages[currentImageIndex]);
        }
      }

      function nextImage() {
        if (originalImages.length === 0) return;

        currentImageIndex = (currentImageIndex + 1) % originalImages.length;
        createViewer(originalImages[currentImageIndex]);
        updateImageCounter();
        updateNavigationButtons();
      }

      function previousImage() {
        if (originalImages.length === 0) return;

        currentImageIndex =
          currentImageIndex === 0
            ? originalImages.length - 1
            : currentImageIndex - 1;
        createViewer(originalImages[currentImageIndex]);
        updateImageCounter();
        updateNavigationButtons();
      }

      function updateImageCounter() {
        const counter = document.getElementById("imageCounter");
        if (counter && originalImages.length > 0) {
          const currentImage = originalImages[currentImageIndex];
          const fileName =
            currentImage.fileName || `Image ${currentImageIndex + 1}`;
          counter.innerHTML = `
                <div style="font-size: 12px;">${currentImageIndex + 1} / ${
            originalImages.length
          }</div>
                <div style="font-size: 10px; opacity: 0.7; max-width: 150px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${fileName}</div>
            `;
        }
      }

      function updateNavigationButtons() {
        const prevBtn = document.getElementById("prevBtn");
        const nextBtn = document.getElementById("nextBtn");

        if (originalImages.length <= 1) {
          prevBtn.style.opacity = "0.3";
          nextBtn.style.opacity = "0.3";
          prevBtn.disabled = true;
          nextBtn.disabled = true;
        } else {
          prevBtn.style.opacity = "1";
          nextBtn.style.opacity = "1";
          prevBtn.disabled = false;
          nextBtn.disabled = false;
        }
      }

      document.addEventListener("DOMContentLoaded", function () {
        init();
        loadImagesFromServer();

        const canvas = document.getElementById("viewer");

        canvas.addEventListener("mousedown", function (e) {
          isMouseDown = true;
          mouseX = e.clientX;
          mouseY = e.clientY;
        });

        document.addEventListener("mouseup", function () {
          isMouseDown = false;
        });

        document.addEventListener("mousemove", function (e) {
          if (!isMouseDown) return;

          const deltaX = e.clientX - mouseX;
          const deltaY = e.clientY - mouseY;

          targetPhi += deltaX * 0.003;
          targetTheta -= deltaY * 0.003;
          targetTheta = Math.max(0.1, Math.min(Math.PI - 0.1, targetTheta));

          mouseX = e.clientX;
          mouseY = e.clientY;
        });

        canvas.addEventListener("wheel", function (e) {
          e.preventDefault();
          camera.fov += e.deltaY * 0.1;
          camera.fov = Math.max(10, Math.min(120, camera.fov));
          camera.updateProjectionMatrix();
        });

        let lastTouchX = 0,
          lastTouchY = 0;

        canvas.addEventListener("touchstart", function (e) {
          e.preventDefault();
          if (e.touches.length === 1) {
            lastTouchX = e.touches[0].clientX;
            lastTouchY = e.touches[0].clientY;
          }
        });

        canvas.addEventListener("touchmove", function (e) {
          e.preventDefault();
          if (e.touches.length === 1) {
            const deltaX = e.touches[0].clientX - lastTouchX;
            const deltaY = e.touches[0].clientY - lastTouchY;

            targetPhi += deltaX * 0.005;
            targetTheta -= deltaY * 0.005;
            targetTheta = Math.max(0.1, Math.min(Math.PI - 0.1, targetTheta));

            lastTouchX = e.touches[0].clientX;
            lastTouchY = e.touches[0].clientY;
          }
        });

        document.addEventListener("keydown", function (e) {
          switch (e.code) {
            case "Space":
              e.preventDefault();
              toggleAutoRotate();
              break;
            case "KeyR":
              resetView();
              break;
            case "KeyT":
              toggleTest();
              break;
            case "ArrowLeft":
              e.preventDefault();
              previousImage();
              break;
            case "ArrowRight":
              e.preventDefault();
              nextImage();
              break;
          }
        });

        window.addEventListener("resize", function () {
          camera.aspect = window.innerWidth / window.innerHeight;
          camera.updateProjectionMatrix();
          renderer.setSize(window.innerWidth, window.innerHeight);
        });
      });
    </script>
  </body>
</html>
